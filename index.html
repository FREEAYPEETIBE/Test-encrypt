<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NZM IPTV</title>
    <link rel="icon" type="image/png" href="nzm.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>
    <style>
      *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
      html,body{
        margin:0;height:100%;overflow:hidden;
        background:#000;color:#fff;font-family:"Segoe UI",Arial,sans-serif;
      }
      :root{--accent:cyan;}
      /* TV mode adjustments will be toggled at runtime via body.tv-mode */
      body.tv-mode { font-size: 18px; }
      body.tv-mode .panel { width: 420px; padding: 22px; }
      body.tv-mode .channel-item { padding: 14px; gap: 16px; }
      body.tv-mode .channel-item img { width: 80px; height: 54px; }
      body.tv-mode #nowPlaying { font-size: 1.05rem; padding: 10px 18px; }

      #videoSection{position:relative;width:100%;height:100vh;background:#000;
        display:flex;align-items:center;justify-content:center;padding:0.5%;
      }
      #videoPlayer{width:100%;height:100%;background:#000;object-fit:contain;}
      #nowPlaying{position:absolute;bottom:15px;right:15px;
        background:rgba(0,0,0,0.45);backdrop-filter:blur(10px);
        border-radius:12px;padding:8px 15px;display:flex;align-items:center;gap:10px;
        box-shadow:0 0 12px var(--accent);
      }
      /* CLOCK (fixed top-right, resizable, PH time) */
    #clock {
      position: absolute;
      top: 10px;
      right: 15px;
      font-weight: bold;
      font-size: var(--clock-size, 1.2em); /* Clock resizer works here */
      color: var(--accent);
      text-shadow: 0 0 6px var(--accent);
      z-index: 99;
    }

    /* NOW PLAYING (smaller, fixed bottom-right) */
    #nowPlaying {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(6px);
      border-radius: 8px;
      padding: 4px 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 0 6px var(--accent);
      transform: scale(0.9);
      z-index: 98;
    }
    #nowPlaying img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    #nowPlaying span {
      font-size: 0.75rem;
      font-weight: 500;
      color: #fff;
      white-space: nowrap;
    }
      #reconnectOverlay{position:absolute;inset:0;display:none;
        align-items:center;justify-content:center;background:rgba(0,0,0,0.65);
        font-size:20px;color:var(--accent);font-weight:bold;z-index:999;
      }
      .panel{position:fixed;top:0;bottom:0;width:320px;
        background:rgba(10,10,10,0.7);backdrop-filter:blur(15px);
        border:1px solid rgba(0,255,255,0.15);overflow-y:auto;padding:15px;
        transition:transform 0.35s ease;z-index:100;
      }
      #channelPanel{left:0;transform:translateX(-100%);}
      #categoryPanel{left:0;transform:translateX(-120%);}
      #settingsPanel{right:0;transform:translateX(100%);}
      .panel h3{text-align:center;color:var(--accent);margin-top:10px;}
      .channel-item,.group-item{
        display:flex;align-items:center;gap:10px;
        padding:10px;border-radius:10px;background:rgba(255,255,255,0.08);
        margin-bottom:10px;cursor:pointer;transition:background 0.2s,transform 0.2s;
      }
      .channel-item:hover,.group-item:hover{
        background:rgba(0,255,255,0.3);transform:scale(1.02);
      }
      .channel-item img{width:50px;height:35px;object-fit:contain;border-radius:6px;}
      ::-webkit-scrollbar{width:6px;}
      ::-webkit-scrollbar-thumb{background:var(--accent);border-radius:6px;}
      #settingsPanel label,#settingsPanel select,#settingsPanel input[type=color],#settingsPanel input[type=range]{
        font-size:15px;width:100%;margin-bottom:10px;
      }
      #settingsPanel select,#settingsPanel input[type=color]{
        padding:8px;border-radius:8px;background:#00141a;color:#bffcff;border:none;
      }
      #settingsPanel input[type=range]{accent-color:var(--accent);}
      video::-webkit-media-controls-timeline,
      video::-webkit-media-controls-current-time-display,
      video::-webkit-media-controls-time-remaining-display{display:none!important;}
      /* Focus visuals for remote */
      .focused{outline:3px solid var(--accent); outline-offset:4px; border-radius:8px;}
    </style>
  </head>
  <body>
    <div id="videoSection">
      <video id="videoPlayer" controls autoplay playsinline></video>
      <div id="nowPlaying">
        <img src="nzm.png" alt="Logo" />
        <span id="nowPlayingText">Now Playing: None</span>
      </div>
      <div id="clock"></div>
      <div id="reconnectOverlay">🔄 Reconnecting...</div>
    </div>

    <aside id="channelPanel" class="panel">
      <h3>All Channels</h3>
      <div id="channelsPanelList"></div>
    </aside>

    <aside id="categoryPanel" class="panel">
      <h3>Categories</h3>
      <div id="categoriesList"></div>
    </aside>

    <aside id="settingsPanel" class="panel">
      <h3>Settings</h3>
      <label><input type="checkbox" id="proxyToggle"> Use Proxy</label><br>
      <label>Playback Speed</label>
      <select id="speedSelect">
        <option value="0.5">0.5x</option>
        <option value="1" selected>1.0x</option>
        <option value="1.25">1.25x</option>
        <option value="1.5">1.5x</option>
        <option value="2">2.0x</option>
      </select>
      <label>Video Player Size</label>
      <select id="sizeSelect">
        <option value="default" selected>Default</option>
        <option value="fill">Fill</option>
        <option value="stretch">Stretch</option>
        <option value="zoom">Zoom</option>
        <option value="fullscreen">Fullscreen</option>
        <option value="fillstretch">Fill + Stretch</option>
      </select>
      <label>Theme Accent Color</label>
      <input type="color" id="themeColor" value="#00ffff">
      <label>Clock Size</label>
      <input type="range" id="clockSize" min="12" max="36" value="18">
      <!-- Only Total Channels line (small, consistent size) -->
      <div style="font-size:15px;margin-top:8px;">Total Channels: <span id="channelCount">0</span></div>
    </aside>

    <script src="channels.js"></script>

  <script>
    /***** Core refs & settings (unchanged) *****/
    const player=document.getElementById("videoPlayer"),
          nowPlayingText=document.getElementById("nowPlayingText"),
          nowPlayingLogo=document.querySelector("#nowPlaying img"),
          reconnectOverlay=document.getElementById("reconnectOverlay"),
          channelPanel=document.getElementById("channelPanel"),
          categoryPanel=document.getElementById("categoryPanel"),
          settingsPanel=document.getElementById("settingsPanel"),
          channelsPanelList=document.getElementById("channelsPanelList"),
          categoriesList=document.getElementById("categoriesList"),
          proxyToggle=document.getElementById("proxyToggle"),
          speedSelect=document.getElementById("speedSelect"),
          sizeSelect=document.getElementById("sizeSelect"),
          themeColor=document.getElementById("themeColor"),
          clockSize=document.getElementById("clockSize"),
          clock=document.getElementById("clock"),
          PROXY="https://cors-proxy.nzmmods.workers.dev/?";
    let useProxy=false;
    proxyToggle.onchange=()=>useProxy=proxyToggle.checked;
    speedSelect.onchange=()=>player.playbackRate=parseFloat(speedSelect.value);
    themeColor.oninput=()=>document.documentElement.style.setProperty("--accent",themeColor.value);
    clockSize.oninput=()=>document.documentElement.style.setProperty("--clock-size",clockSize.value+"px");

    sizeSelect.onchange=()=>{
      player.style.objectFit="contain";player.style.transform="none";
      switch(sizeSelect.value){
        case"fill":player.style.objectFit="fill";break;
        case"stretch":player.style.width="100vw";player.style.height="100vh";break;
        case"zoom":player.style.objectFit="cover";break;
        case"fullscreen":if(player.requestFullscreen)player.requestFullscreen();break;
        case"fillstretch":player.style.objectFit="fill";player.style.width="100vw";player.style.height="100vh";break;
        default:player.style.width="100%";player.style.height="100%";
      }
    };

  // PH clock 12h
  function updateClock() {
    const opts = { timeZone: "Asia/Manila", hour12: true, hour: "numeric", minute: "2-digit" };
    clock.textContent = new Intl.DateTimeFormat("en-PH", opts).format(new Date()).toUpperCase();
  }
  setInterval(updateClock, 1000);
  updateClock();

  // ✅ Clock Resizer Feature (put this right after the clock update)
  function setClockSize(size) {
    document.documentElement.style.setProperty('--clock-size', size + 'em');
  }

    // Panels state & helpers (unchanged)
    let state={channelOpen:false,categoryOpen:false,settingsOpen:false};
    function openPanel(p){p.style.transform='translateX(0)';}
    function closePanel(p){
      if(p===channelPanel)p.style.transform='translateX(-100%)';
      if(p===categoryPanel)p.style.transform='translateX(-120%)';
      if(p===settingsPanel)p.style.transform='translateX(100%)';
    }

    /***** TV detection & mode *****/
    const tvUaRegex = /SMART|BRAVIA|TIZEN|AFT|ANDROID TV|Android TV|MiTV|Hisense|Philips|TCL|SHIELD|GoogleTV|Google TV|SmartTV/i;
    const isTV = tvUaRegex.test(navigator.userAgent) || (screen && Math.max(screen.width, screen.height) >= 1280 && navigator.userAgent.includes("Android"));
    if (isTV) {
      document.body.classList.add('tv-mode');
      // disable touch-based swipes on TVs (touch listeners not attached below)
    }

    /***** Swipe for touch devices (only if not TV) *****/
    let startX=null,startY=null;const TH=60,VT=120;
    if(!isTV){
      document.addEventListener("touchstart",e=>{const t=e.touches?e.touches[0]:e;startX=t.clientX;startY=t.clientY;});
      document.addEventListener("touchend",e=>{
        if(startX===null)return;
        const t=e.changedTouches?e.changedTouches[0]:e,dx=t.clientX-startX,dy=t.clientY-startY;startX=null;
        if(Math.abs(dy)>VT)return;
        if(dx>TH){
          if(state.settingsOpen){closePanel(settingsPanel);state.settingsOpen=false;return;}
          if(!state.channelOpen&&!state.categoryOpen){openPanel(channelPanel);state.channelOpen=true;}
          else if(state.channelOpen&&!state.categoryOpen){openPanel(categoryPanel);state.categoryOpen=true;}
        }else if(dx<-TH){
          if(state.categoryOpen){closePanel(categoryPanel);state.categoryOpen=false;return;}
          if(state.channelOpen){closePanel(channelPanel);state.channelOpen=false;return;}
          if(!state.settingsOpen){openPanel(settingsPanel);state.settingsOpen=true;}
          else{closePanel(settingsPanel);state.settingsOpen=false;}
        }
      });
    }

    /***** Channels (unchanged but added tabindex and keyboard enter support) *****/
    function renderChannels(){
      channelsPanelList.innerHTML="";categoriesList.innerHTML="";
      const cats=new Set();if(!window.channels||!window.channels.length)return;
      window.channels.forEach((ch,i)=>{
        const el=document.createElement("div");
        el.className="channel-item";el.tabIndex=0;
        el.innerHTML=`<img src="${ch.logo||'nzm.png'}"><div><b>${ch.name}</b><br><small>${ch.category||''}</small></div>`;
        el.onclick=()=>playChannel(i);
        // keyboard Enter for focused element
        el.addEventListener('keydown', ev => { if(ev.key === 'Enter' || ev.keyCode === 13) el.click(); });
        channelsPanelList.appendChild(el);
        if(ch.category)cats.add(ch.category);
      });
      cats.forEach(c=>{
        const cat=document.createElement("div");
        cat.className="group-item";cat.textContent=c;cat.tabIndex=0;
        cat.onclick=()=>filterCategory(c);
        cat.addEventListener('keydown', ev => { if(ev.key === 'Enter' || ev.keyCode === 13) ev.target.click(); });
        categoriesList.appendChild(cat);
      });

      // ✅ Update channel count in settings (overall total)
      const countEl = document.getElementById("channelCount");
      if(countEl) countEl.textContent = (window.channels && window.channels.length) ? window.channels.length : 0;
    }
    function filterCategory(cat){
      channelsPanelList.innerHTML="";
      window.channels.forEach((ch,i)=>{
        if(ch.category!==cat)return;
        const el=document.createElement("div");
        el.className="channel-item";el.tabIndex=0;
        el.innerHTML=`<img src="${ch.logo||'nzm.png'}"><div><b>${ch.name}</b><br><small>${ch.category||''}</small></div>`;
        el.onclick=()=>playChannel(i);
        el.addEventListener('keydown', ev => { if(ev.key === 'Enter' || ev.keyCode === 13) el.click(); });
        channelsPanelList.appendChild(el);
      });
      closePanel(categoryPanel);openPanel(channelPanel);
    }

    /***** Shaka/Hls + playChannel (unchanged) *****/
    async function initShaka(){if(!window.shaka||!shaka.Player.isBrowserSupported())return false;shaka.polyfill.installAll();return true;}
    async function playChannel(i){
      const ch=window.channels[i];
      if(!ch) return;
      nowPlayingText.textContent="Now Playing: "+ch.name;
      nowPlayingLogo.src=ch.logo||"nzm.png";
      const url=ch.url.trim(),playUrl=useProxy?PROXY+url:url;
      player.pause();
      if(player.hls){try{player.hls.destroy();}catch(e){} player.hls=null;}
      if(player.shaka){try{player.shaka.destroy();}catch(e){} player.shaka=null;}
      try{
        if(playUrl.endsWith(".m3u8")){
          if(Hls.isSupported()){
            const hls=new Hls({maxBufferLength:30});
            hls.loadSource(playUrl);
            hls.attachMedia(player);
            player.hls=hls;
          } else player.src=playUrl;
        }else if(playUrl.endsWith(".mpd")){
          const supported=await initShaka();
          if(supported){
            const shakaPlayer=new shaka.Player(player);
            player.shaka=shakaPlayer;
            const config={streaming:{bufferingGoal:15}};
            if(ch.clearKey)config.drm={clearKeys:ch.clearKey};
            shakaPlayer.configure(config);
            await shakaPlayer.load(playUrl);
          }else player.src=playUrl;
        }else player.src=playUrl;
        await player.play();
        enterFullscreen();
      }catch(err){console.error("Playback failed:",err);try{alert("Playback failed for "+ch.name);}catch(e){}}
    }
    function enterFullscreen(){try{ // only auto-fullscreen on TV devices
        if(isTV){
          if(player.requestFullscreen) player.requestFullscreen();
          else if(player.webkitEnterFullscreen) player.webkitEnterFullscreen();
        }
      }catch(e){}}
    function exitFullscreen(){ try{ if(document.fullscreenElement) document.exitFullscreen(); else if(document.webkitIsFullScreen) document.webkitExitFullscreen(); }catch(e){} }

    /***** Smart reconnect (unchanged logic) *****/
    let last=0,freeze=0;
    setInterval(()=>{
      if(!player||player.paused) { last = player ? player.currentTime : 0; return; }
      const t=player.currentTime;
      if(Math.abs(t-last)<0.1){
        freeze++;
        if(freeze>=3){
          reconnectOverlay.style.display="flex";
          setTimeout(()=>reconnectOverlay.style.display="none",2000);
          const currentName = nowPlayingText.textContent.replace(/^Now Playing:\s*/, "");
          const i=window.channels.findIndex(c=>c.name===currentName);
          if(i>=0) playChannel(i);
          freeze=0;
        }
      } else freeze=0;
      last=t;
    },6000);

    /***** TV Remote navigation logic (non-destructive) *****/
    // focusIndex used when navigating channel list with remote
    let focusIndex = 0;
    function updateFocus(list){
      list.forEach(el=>el.classList.remove("focused"));
      if(list[focusIndex]) list[focusIndex].classList.add("focused");
      list[focusIndex]?.scrollIntoView({block:"center",behavior:"smooth"});
    }

    // Long-press detection for Enter/OK (toggle fullscreen)
    let enterPressStart = 0;
    const LONG_PRESS_MS = 600;

    function handleBackAction(){
      // 1) close any open panels
      if(state.settingsOpen){ closePanel(settingsPanel); state.settingsOpen=false; return; }
      if(state.categoryOpen){ closePanel(categoryPanel); state.categoryOpen=false; return; }
      if(state.channelOpen){ closePanel(channelPanel); state.channelOpen=false; return; }
      // 2) if fullscreen -> exit fullscreen
      if(document.fullscreenElement){ exitFullscreen(); return; }
      // 3) if playing -> pause
      if(!player.paused){ player.pause(); return; }
      // 4) try to call Android exit (AIDE WebView can expose Android.exitApp)
      try{ if(window.Android && Android.exitApp) Android.exitApp(); else history.back(); }catch(e){ try{ history.back(); }catch(_){} }
    }

    document.addEventListener('keydown', (e) => {
      // Normalize key value
      const key = e.key || e.code || e.keyCode;
      // Get channel items for navigation
      const items = Array.from(document.querySelectorAll('#channelsPanelList .channel-item'));
      if(!items.length) return;

      // Prevent default scrolling on TV for arrow keys
      if(isTV && ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Enter','Backspace','Escape'].includes(e.key)) {
        try{ e.preventDefault(); }catch(_){}
      }

      switch(e.key){
        case 'ArrowDown':
          focusIndex = Math.min(items.length - 1, focusIndex + 1);
          updateFocus(items);
          break;
        case 'ArrowUp':
          focusIndex = Math.max(0, focusIndex - 1);
          updateFocus(items);
          break;
        case 'ArrowLeft':
          // Navigate panels: left closes settings or categories, or opens channel panel
          if(state.settingsOpen){ closePanel(settingsPanel); state.settingsOpen=false; }
          else if(state.categoryOpen){ closePanel(categoryPanel); state.categoryOpen=false; }
          else if(!state.channelOpen){ openPanel(channelPanel); state.channelOpen=true; }
          break;
        case 'ArrowRight':
          // Right opens settings when channel panel is visible
          if(state.channelOpen){ closePanel(channelPanel); state.channelOpen=false; openPanel(settingsPanel); state.settingsOpen=true; }
          break;
        case 'Enter':
        case 'OK':
          // Start long-press timer
          enterPressStart = Date.now();
          // short-press behavior handled on keyup to allow long-press detection
          break;
        case 'Backspace':
        case 'Escape':
          handleBackAction();
          break;
        default:
          break;
      }
    });

    document.addEventListener('keyup', (e) => {
      if(e.key === 'Enter' || e.key === 'OK'){
        const duration = Date.now() - enterPressStart;
        const items = Array.from(document.querySelectorAll('#channelsPanelList .channel-item'));
        if(duration >= LONG_PRESS_MS){
          // Long press => toggle fullscreen
          if(document.fullscreenElement) exitFullscreen(); else enterFullscreen();
        } else {
          // Short press => activate current focused item
          if(items[focusIndex]) items[focusIndex].click();
        }
        enterPressStart = 0;
      }
    });

    // Also support remote play/pause media keys
    document.addEventListener('keydown', (ev) => {
      if(ev.key === 'MediaPlayPause' || ev.keyCode === 179 || ev.code === 'MediaPlayPause') {
        try{ ev.preventDefault(); }catch(_){}
        if(player.paused) player.play(); else player.pause();
      }
    });

      /***** Auto-focus first channel on TV for immediate navigation *****/
    window.addEventListener("load", ()=>{
      renderChannels();
      // focus first UI element for TV
      const first = document.querySelector('.channel-item');
      if(first){
        // set focused class for remote navigation
        focusIndex = 0;
        updateFocus(Array.from(document.querySelectorAll('#channelsPanelList .channel-item')));
        // also programmatically focus for keyboard support
        try{ if(isTV) first.focus(); }catch(e){}
      }
      if(window.channels?.length) playChannel(0);
    });
  </script>

    <!-- === SECURITY: ANTI-INSPECT / DEVTOOLS PROTECTION (STANDARD) === -->
    <script>
    (() => {
      // Disable right-click context menu
      document.addEventListener("contextmenu", e => e.preventDefault());

      // Block keyboard shortcuts commonly used to inspect or view source
      document.addEventListener("keydown", e => {
        const key = e.key?.toUpperCase();
        if (
          key === "F12" ||
          (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(key)) ||
          (e.ctrlKey && key === "U")
        ) {
          e.preventDefault();
          e.stopPropagation();
          alert("🔒 Developer Tools are disabled for security reasons.");
          return false;
        }
      });

      // Simple DevTools detection using timing trick
      let devOpen = false;
      const threshold = 160;
      setInterval(() => {
        const start = new Date();
        debugger;
        const diff = new Date() - start;
        if (diff > threshold && !devOpen) {
          devOpen = true;
          alert("⚠️ Developer Tools detected! Reloading for protection...");
          location.reload();
        }
      }, 1200);
    })();
    </script>
    <!-- === END SECURITY BLOCK === -->
  </body>
</html> 
